#!/bin/bash
set -e

LINKS=$(mktemp)
AUDIO_DIR="/html/audio"
NUMBER_OF_ENTRIES=24 # number of entries to keep * 2 + 2

extractLinks > ${LINKS}
youtube-dl --write-thumbnail --ignore-errors --batch-file ${LINKS} -o "${AUDIO_DIR}/%(title)s.%(ext)s"
ls --sort=time ${AUDIO_DIR}/*.{mp3,jpg} | tail -n +${NUMBER_OF_ENTRIES} | xargs -I{} rm -v "{}"

pushd /html/
generateFeed

# Ping healthchecks
curl https://hchk.io/92bd7a41-b412-4b9e-ad16-29c754be2822
