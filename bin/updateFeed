#!/bin/bash
set -e

LINKS=$(mktemp)
AUDIO_DIR="/html/audio"
NUMBER_OF_ENTRIES=12 # number of entries to keep + 1

extractLinks > ${LINKS}
youtube-dl --ignore-errors --batch-file ${LINKS} -o "${AUDIO_DIR}/%(title)s.%(ext)s"
ls --sort=time ${AUDIO_DIR}/*.mp3 | tail -n +${NUMBER_OF_ENTRIES} | xargs -I{} rm -v "{}"

pushd /html/
genRSS -C -d audio/ --host ellinofreneia.sealabs.net \
       -e mp3 \
       -t "Ελληνοφρένεια" \
       -p "Ραδιοφωνική Ελληνοφρένεια (ανεπίσημο)" \
       -i "https://ellinofreneia.sealabs.net/cover.png" \
       -o feed.rss

# Ping healthchecks
curl https://hchk.io/92bd7a41-b412-4b9e-ad16-29c754be2822
